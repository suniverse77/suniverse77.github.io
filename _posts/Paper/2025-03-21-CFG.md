---
title: "[ë…¼ë¬¸ë¦¬ë·°] Classifier-Free Diffusion Guidance"
date: 2025-03-21 12:00:00 +/-TTTT
categories: [ë…¼ë¬¸ë¦¬ë·°, Generative AI]
tags: [Diffusion, Image Generation]
math: true
toc: true
author: sunho
description: ğŸ“ NeurIPS Workshop 2021
---

[[Paper]](https://arxiv.org/abs/2207.12598)

<details>
<summary><font color='#FF8C00'>ğŸ“ Summary</font></summary>
<div markdown="1">
<br>


</div>
</details>
<br>

![fig0](paper/CFG-0.png){: style="display:block; margin:0 auto; width:100%;"}

## Introduction

**ê¸°ì¡´ ì—°êµ¬ë“¤ì˜ í•œê³„ì **

Classifier guidanceëŠ” ì•„ë˜ì˜ ë¬¸ì œì ì´ ìˆë‹¤.

- ì¶”ê°€ì ì¸ classifier í•™ìŠµì´ í•„ìš”í•˜ê¸° ë•Œë¬¸ì— diffusion ëª¨ë¸ì˜ í•™ìŠµ íŒŒì´í”„ë¼ì¸ì„ ë³µì¡í•˜ê²Œ ë§Œë“ ë‹¤.
- ì‚¬ìš©í•˜ëŠ” classifierëŠ” ë…¸ì´ì¦ˆê°€ ì„ì¸ ë°ì´í„° ìœ„ì—ì„œ í•™ìŠµë˜ì–´ì•¼ í•˜ë¯€ë¡œ, ì¼ë°˜ì ì¸ ì‚¬ì „í•™ìŠµëœ classifierë¥¼ ë°”ë¡œ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
- FID, IS ë“±ì˜ metricì€ ì‚¬ì „í•™ìŠµëœ classifierë¥¼ ê¸°ë°˜ìœ¼ë¡œ í‰ê°€í•˜ëŠ”ë°, ì´ ë°©ì‹ì€ scoreë¥¼ ì§ì ‘ì ìœ¼ë¡œ ë”í•˜ë©´ì„œ í´ë˜ìŠ¤ ë°©í–¥ìœ¼ë¡œ ìƒ˜í”Œë§ì„ ìœ ë„í•˜ê¸° ë•Œë¬¸ì— classifierê°€ ì˜ ë§ì¶”ê²Œë” ì´ë¯¸ì§€ì— ì‘ì€ ì¡°ì‘ì„ ë°˜ë³µí•˜ëŠ” ê²ƒìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë‹¤.

    ë”°ë¼ì„œ ì§„ì§œ ì¢‹ì€ ì´ë¯¸ì§€ë¥¼ ë§Œë“  ê²ƒì¸ì§€, classifierë¥¼ ì˜ ì†ì¸ ê²°ê³¼ì¸ì§€ê°€ ë¶ˆë¶„ëª…í•˜ë‹¤.

**ì œì•ˆí•˜ëŠ” ë°©ë²•**

ë¶„ë¥˜ê¸°ë¥¼ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” guidance ê¸°ë²•ì„ ì œì•ˆí•œë‹¤.

- Conditional ë””í“¨ì „ ëª¨ë¸ì˜ socre ì¶”ì •ê°’ê³¼ unconditional ë””í“¨ì „ ëª¨ë¸ì˜ score ì¶”ì •ê°’ì„ í˜¼í•©í•œë‹¤.

## Methods

GANì´ë‚˜ flow-based ëª¨ë¸ê³¼ ê°™ì€ ìƒì„± ëª¨ë¸ì€ ìƒ˜í”Œë§ ë•Œ ì…ë ¥ ë…¸ì´ì¦ˆì˜ ë¶„ì‚° ë˜ëŠ” ë²”ìœ„ë¥¼ ì¤„ì„ìœ¼ë¡œì¨ truncated sampling ë˜ëŠ” low temperature samplingì„ ìˆ˜í–‰í•  ìˆ˜ ìˆë‹¤.

ì´ëŸ¬í•œ ë°©ì‹ì€ ìƒ˜í”Œì˜ ë‹¤ì–‘ì„±ì„ ì¤„ì´ì§€ë§Œ, ê° ìƒ˜í”Œì˜ í’ˆì§ˆì„ ë†’ì¼ ìˆ˜ ìˆë‹¤.

ê·¸ëŸ¬ë‚˜ ìœ„ì˜ ë°©ì‹ì„ ë””í“¨ì „ ëª¨ë¸ì— ì ìš©í•˜ê¸° ìœ„í•´, scoreë¥¼ ìŠ¤ì¼€ì¼ë§í•˜ê±°ë‚˜ reverse processì—ì„œ ê°€ìš°ì‹œì•ˆ ë…¸ì´ì¦ˆì˜ ë¶„ì‚°ì„ ì¤„ì´ëŠ” ë°©ì‹ì„ ì‚¬ìš©í•˜ë©´ ì˜¤íˆë ¤ ì €í’ˆì§ˆì˜ ìƒ˜í”Œì„ ìƒì„±í•˜ê²Œ ë§Œë“ ë‹¤.

### 1. Classifier Guidance

ë””í“¨ì „ ëª¨ë¸ì—ì„œ truncationê³¼ ìœ ì‚¬í•œ íš¨ê³¼ë¥¼ ì–»ê¸° ìœ„í•´ [Diffusion models beat GANs on image synthesis]() ë…¼ë¬¸ì—ì„œëŠ” classifier guidance ê¸°ë²•ì„ ë„ì…í•˜ì˜€ë‹¤.

ì´ ê¸°ë²•ì—ì„œëŠ” ë””í“¨ì „ ëª¨ë¸ì˜ score ${\boldsymbol\epsilon}\_\theta(\mathbf{z}\_\lambda,\mathbf{c})\approx\sigma\_\lambda\nabla\_{\mathbf{z}\_\lambda}\log p\_\theta(\mathbf{z}\_\lambda\mid\mathbf{c})$ì— auxiliary classifier ëª¨ë¸ $p\_\theta(\mathbf{c}\mid\mathbf{z}_\lambda)$ì˜ log-likelihoodì˜ gradientë¥¼ í¬í•¨ì‹œí‚¨ë‹¤.

$$
\tilde{\boldsymbol\epsilon}_\theta(\mathbf{z}_\lambda,\mathbf{c})
={\boldsymbol\epsilon}_\theta(\mathbf{z}_\lambda,\mathbf{c})-w\sigma_\lambda\nabla_{\mathbf{z}_\lambda}\log p_\theta(\mathbf{c}\mid\mathbf{z}_\lambda)
\approx\sigma_\lambda\nabla_{\mathbf{z}_\lambda}[\log p_\theta(\mathbf{z}_\lambda\mid\mathbf{c})+w\log p_\theta(\mathbf{c}\mid\mathbf{z}_\lambda)]
$$

ìœ„ì˜ ìˆ˜ì‹ì—ì„œ $w$ëŠ” classifier guidanceì˜ ê°•ë„ë¥¼ ì¡°ì ˆí•˜ëŠ” í•˜ì´í¼íŒŒë¼ë¯¸í„°ì´ë‹¤.

ìƒ˜í”Œë§ ë•ŒëŠ” ê¸°ì¡´ score ${\boldsymbol\epsilon}\_\theta(\mathbf{z}\_\lambda,\mathbf{c})$ ëŒ€ì‹  ë³€ê²½ëœ score $\tilde{\boldsymbol\epsilon}\_\theta(\mathbf{z}\_\lambda,\mathbf{c})$ê°€ ì‚¬ìš©ë˜ë©°, ì´ëŠ” ì•„ë˜ì™€ ê°™ì€ ë¶„í¬ë¡œë¶€í„° ìƒ˜í”Œë§ì„ í•˜ëŠ” ê²ƒê³¼ ë™ì¼í•˜ë‹¤.

$$
\tilde{p}_\theta(\mathbf{z}_\lambda \mid \mathbf{c})
\propto p_\theta(\mathbf{z}_\lambda \mid \mathbf{c}) \, p_\theta(\mathbf{c} \mid \mathbf{z}_\lambda)^w
$$

ì´ë•Œ, ë¶„ë¥˜ê¸° $p_\theta(\mathbf{c} \mid \mathbf{z}_\lambda)$ê°€ í•´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤ $c$ì— ëŒ€í•´ ë†’ì€ likelihoodë¥¼ ë¶€ì—¬í•˜ë„ë¡ ê°€ì¤‘ì¹˜ë¥¼ ì¡°ì •í•˜ë©°, $w>0$ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ìƒì„±ëœ ìƒ˜í”Œì˜ ë‹¤ì–‘ì„±ì´ ê°ì†Œí•˜ì§€ë§Œ ISê°€ í–¥ìƒëœë‹¤.

ì•„ë˜ì˜ ê´€ê³„ ë•Œë¬¸ì— ì´ë¡ ì ìœ¼ë¡œ, unconditional ëª¨ë¸ì— ê°€ì¤‘ì¹˜ $w+1$ì˜ classifier guidanceë¥¼ ì ìš©í•˜ë©´, conditional ëª¨ë¸ì— $w$ì˜ guidanceë¥¼ ì ìš©í•œ ê²ƒê³¼ ë™ì¼í•œ ê²°ê³¼ë¥¼ ì–»ì„ ìˆ˜ ìˆë‹¤.

$$
p_\theta(\mathbf{z}_\lambda \mid \mathbf{c}) \, p_\theta(\mathbf{c} \mid \mathbf{z}_\lambda)^w
=p_\theta(\mathbf{z}_\lambda)p_\theta(\mathbf{c} \mid \mathbf{z}_\lambda)^{w+1}
$$

Score ê´€ì ì—ì„œëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

$$
\epsilon_\theta(\mathbf{z}_\lambda)
- (w + 1) \, \sigma_\lambda \, \nabla_{\mathbf{z}_\lambda} \log p_\theta(\mathbf{c} \mid \mathbf{z}_\lambda)
\approx -\sigma_\lambda \, \nabla_{\mathbf{z}_\lambda}
\left[
\log p(\mathbf{z}_\lambda) + (w + 1) \log p_\theta(\mathbf{c} \mid \mathbf{z}_\lambda)
\right]
\\ ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
= -\sigma_\lambda \, \nabla_{\mathbf{z}_\lambda}
\left[
\log p(\mathbf{z}_\lambda \mid \mathbf{c}) + w \log p_\theta(\mathbf{c} \mid \mathbf{z}_\lambda)
\right]
$$

í•˜ì§€ë§Œ Diffusion models beat GANs on image synthesisì˜ ì €ìë“¤ì€ ì´ë¯¸ unconditional ëª¨ë¸ì— guidanceë¥¼ ì ìš©í•˜ëŠ” ê²ƒë³´ë‹¤ conditionalë¡œ í•™ìŠµëœ ëª¨ë¸ì— guidanceë¥¼ ì ìš©í•˜ëŠ” ê²½ìš°ì— ì„±ëŠ¥ì´ ë” ìš°ìˆ˜í•¨ì„ ë°œê²¬í•˜ì˜€ê³ , ë”°ë¼ì„œ ë³¸ ì—°êµ¬ì—ì„œëŠ” conditional ëª¨ë¸ì— guidanceë¥¼ ì ìš©í•˜ëŠ” ì„¤ì •ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë…¼ì˜ë¥¼ í•œë‹¤.

### 2. Classifier-Free Guidance

Classifier guidanceëŠ” ì´ë¯¸ì§€ classifierì˜ graidentì— ì˜ì¡´í•œë‹¤ëŠ” í•œê³„ì ì´ ìˆë‹¤.

ë³„ë„ì˜ classifierë¥¼ í•™ìŠµí•˜ëŠ” ëŒ€ì‹ , ì•„ë˜ì˜ ë‘ ëª¨ë¸ì„ í•¨ê»˜ í•™ìŠµí•œë‹¤.

- Unconditional denoising ë””í“¨ì „ ëª¨ë¸ $p_\theta(\mathbf{z})$: ì´ ëª¨ë¸ì˜ score ì¶”ì •ê°’ì€ $\boldsymbol\epsilon_\theta(\mathbf{z}_\lambda)$
- Conditional ë””í“¨ì „ ëª¨ë¸ $p_\theta(\mathbf{z}\mid\mathbf{c})$: ì´ ëª¨ë¸ì˜ score ì¶”ì •ê°’ì€ $\boldsymbol\epsilon_\theta(\mathbf{z}_\lambda,\mathbf{c})$

íŒŒë¼ë¯¸í„° ì¦ê°€ ì—†ì´ ìœ„ ë‘ ëª¨ë¸ì„ ë™ì‹œì— í•™ìŠµí•˜ê¸° ìœ„í•´ ì•„ë˜ì˜ ì „ëµì„ ì‚¬ìš©í•˜ì˜€ë‹¤.

- Unconditional ëª¨ë¸ì˜ ê²½ìš° conditional ëª¨ë¸ì˜ class identifier $\mathbf{c}$ë¡œ null token $\varnothing$ì„ ì…ë ¥ìœ¼ë¡œ ì¤€ë‹¤. ì¦‰, $\boldsymbol\epsilon_\theta(\mathbf{z}\_\lambda)=\boldsymbol\epsilon\_\theta(\mathbf{z}_\lambda,\mathbf{c}=\varnothing)$ì´ë‹¤.
- í•˜ì´í¼íŒŒë¼ë¯¸í„° $p_{\text{uncond}}$ë¥¼ ì„¤ì •í•´ $p_{\text{uncond}}$ì˜ í™•ë¥ ë¡œ $\mathbf{c}$ë¥¼ $\varnothing$ìœ¼ë¡œ ë§Œë“¤ì–´ ëª¨ë¸ì— ì…ë ¥í•œë‹¤.

ì´í›„ ì•„ë˜ì™€ ê°™ì´ conditionalê³¼ unconditional score ì¶”ì •ê°’ì„ ì„ í˜• ê²°í•©í•˜ì—¬ ìƒ˜í”Œë§í•œë‹¤.

$$
\tilde{\boldsymbol\epsilon}_\theta(\mathbf{z}_\lambda,\mathbf{c})=
(1+w){\boldsymbol\epsilon}_\theta(\mathbf{z}_\lambda,\mathbf{c})-w{\boldsymbol\epsilon}_\theta(\mathbf{z}_\lambda)
$$

Classifier-Free Guidanceì˜ í•™ìŠµê³¼ ìƒ˜í”Œë§ ì•Œê³ ë¦¬ì¦˜ì€ ì•„ë˜ì™€ ê°™ë‹¤.

![fig1](paper/CFG-1.png){: style="display:block; margin:0 auto; width:100%;"}

![fig2](paper/CFG-2.png){: style="display:block; margin:0 auto; width:100%;"}

## Experiments

### Varying the Classifier-Free Guidance Strength

![fig3](paper/CFG-3.png){: style="display:block; margin:0 auto; width:100%;"}

ìœ„ì˜ ê·¸ë¦¼ì—ì„œ ì™¼ìª½ì€ $w=0$ (non-guided)ì¼ ë•Œ ìƒì„±ëœ ìƒ˜í”Œ, ì˜¤ë¥¸ìª½ì€ $w=3$ì¼ ë•Œ ìƒì„±ëœ ìƒ˜í”Œ ê²°ê³¼ì´ë‹¤.

Classifier-free guidance strenghtê°€ í´ìˆ˜ë¡ fidelityëŠ” ì¦ê°€í•˜ì§€ë§Œ ë‹¤ì–‘ì„±ì´ ê°ì†Œí•œë‹¤.

![fig4](paper/CFG-4.png){: style="display:block; margin:0 auto; width:80%;"}

![fig5](paper/CFG-5.png){: style="display:block; margin:0 auto; width:80%;"}

ìœ„ì˜ í‘œì™€ ê·¸ë¦¼ì€ classifier-free guidance strenghtì— ë”°ë¥¸ FIDì™€ ISë¥¼ ë¹„êµí•œ ê²°ê³¼ë¥¼ ë‚˜íƒ€ë‚¸ë‹¤.
